<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>管理后台 - App WWZ</title>
<link rel="icon" href="https://wangwenzhi.eu.org/images/ulefone-logo/icon.png" sizes="32x32" type="image/png"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --bg-app: #f5f5f7;        
        --bg-surface: #ffffff;    
        --bg-block: #efeff1;      
        --bg-active: #e5e5e7;     
        
        --text-main: #000000;
        --text-sub: #86868b;
        
        --accent: #000000;
        --accent-fg: #ffffff;
        --danger: #ff3b30;
        --danger-bg: #fff2f2;
        
        --sidebar-width: 240px; 
        --header-height: 60px; /* 移动端顶栏高度 */
        --pill: 99px;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --bg-app: #000000;
            --bg-surface: #1c1c1e;
            --bg-block: #2c2c2e;
            --bg-active: #3a3a3c;
            --text-main: #ffffff;
            --text-sub: #98989d;
            --accent: #ffffff;
            --accent-fg: #000000;
            --danger-bg: #3a0b0b;
        }
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        background: var(--bg-app);
        color: var(--text-main);
        font-size: 16px;
        margin: 0;
        overflow-x: hidden;
    }

    /* === Mobile Header (仅手机显示) === */
    .mobile-header {
        display: none;
        height: var(--header-height);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        align-items: center; justify-content: space-between;
        padding: 0 20px;
        position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
    }
    body.dark-mode .mobile-header { background: rgba(28, 28, 30, 0.9); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .menu-toggle { font-size: 20px; cursor: pointer; color: var(--text-main); }
    .mobile-title { font-weight: 700; font-size: 16px; }

    /* === Sidebar === */
    aside {
        width: var(--sidebar-width);
        background: var(--bg-surface);
        padding: 30px 16px;
        position: fixed; top: 0; bottom: 0; left: 0;
        overflow-y: auto; z-index: 900;
        border-right: 1px solid rgba(0,0,0,0.03);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    body.dark-mode aside { border-right: 1px solid rgba(255,255,255,0.05); }

    .brand {
        display: flex; align-items: center; gap: 14px;
        font-size: 20px; font-weight: 800; color: var(--text-main);
        margin-bottom: 30px; padding-left: 8px; cursor: pointer;
    }
    .brand img { width: 36px; height: 36px; border-radius: 8px; }

    .nav-list { display: flex; flex-direction: column; gap: 4px; margin-bottom: 40px; }

    .nav-item {
        padding: 12px 16px; border-radius: var(--pill); 
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        color: var(--text-sub); font-size: 15px; font-weight: 600;
        background: transparent; transition: all 0.2s;
    }
    .nav-item:hover { background: var(--bg-block); color: var(--text-main); }
    .nav-item.active { background: var(--bg-active); color: var(--text-main); font-weight: 700; }
    .nav-item.active .badge { background: #dcdce0; color: var(--text-main); }
    
    .badge { 
        font-size: 12px; background: var(--bg-block); padding: 2px 8px; 
        border-radius: 99px; color: var(--text-sub); transition: all 0.2s; font-weight: 600;
    }

    .sidebar-footer { margin-top: auto; display: flex; flex-direction: column; gap: 12px; }

    /* === Main Content === */
    main {
        margin-left: var(--sidebar-width);
        padding: 40px 50px 100px 50px; 
        background: var(--bg-app); 
        min-height: 100vh;
        transition: margin-left 0.3s;
    }

    /* 顶部统计区 (Compact Layout - 同步前台) */
    .dashboard-header {
        background: var(--bg-surface); 
        border-radius: 20px; 
        padding: 24px 32px; 
        margin-bottom: 30px;
        display: flex; 
        flex-direction: row; 
        align-items: center; 
        justify-content: space-between; 
        gap: 24px;
    }
    .dash-info h1 { font-size: 24px; font-weight: 800; margin: 0 0 4px 0; letter-spacing: -0.5px; }
    .dash-info p { margin: 0; font-size: 13px; color: var(--text-sub); font-weight: 500; }
    
    .stats-row { display: flex; gap: 16px; }
    .stat-pill {
        background: var(--bg-block); padding: 12px 24px; border-radius: 14px;
        display: flex; flex-direction: column; min-width: 100px;
        text-align: center;
    }
    .stat-val { font-size: 22px; font-weight: 800; line-height: 1.2; color: var(--text-main); margin-bottom: 2px; }
    .stat-lbl { font-size: 12px; color: var(--text-sub); font-weight: 600; }

    .cat-section { margin-bottom: 50px; scroll-margin-top: 80px; }
    .cat-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
    .cat-title-input {
        font-size: 22px; font-weight: 800; background: transparent; border: none;
        color: var(--text-main); flex: 1; padding: 8px 0; border-radius: 8px; transition: all 0.2s;
    }
    .cat-title-input:hover, .cat-title-input:focus { padding-left: 12px; background: var(--bg-block); }

    /* Cards (同步前台加大图标) */
    .app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
    .app-card {
        background: var(--bg-surface); border-radius: 16px; padding: 16px;
        display: flex; flex-direction: row; align-items: center; position: relative;
        cursor: grab; transition: transform 0.2s, box-shadow 0.2s; min-height: 80px;
    }
    .app-card:hover { transform: translateY(-3px); z-index: 2; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .app-card:active { cursor: grabbing; transform: scale(0.98); }
    
    .icon-wrapper { 
        width: 48px; height: 48px; /* 图标容器加大 */
        margin-right: 16px; 
        border-radius: 12px; 
        background: var(--bg-block); 
        overflow: hidden; flex-shrink: 0; 
        display: flex; align-items: center; justify-content: center; 
    }
    .app-icon-img { width: 70%; height: 70%; object-fit: contain; } /* 图标占比加大 */
    
    .card-meta { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
    .app-name { font-size: 15px; font-weight: 700; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .app-desc { font-size: 12px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Controls */
    .card-controls { position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
    .app-card:hover .card-controls { opacity: 1; }
    .control-btn {
        width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        background: var(--bg-block); color: var(--text-main); font-size: 12px; transition: background 0.2s;
    }
    .control-btn:hover { background: var(--bg-active); }
    .control-btn.btn-del { background: var(--danger-bg); color: var(--danger); }
    .control-btn.btn-del:hover { background: var(--danger); color: #fff; }

    .add-card {
        background: transparent; border: 2px dashed var(--bg-block); border-radius: 16px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: var(--text-sub); cursor: pointer; min-height: 80px;
        font-size: 13px; gap: 6px; font-weight: 600; transition: all 0.2s;
    }
    .add-card:hover { border-color: var(--text-main); color: var(--text-main); background: var(--bg-block); }

    .add-category-block {
        background: var(--bg-surface); border-radius: 20px; padding: 20px;
        text-align: center; color: var(--text-sub); cursor: pointer;
        margin-top: 30px; font-weight: 600; transition: all 0.2s; font-size: 15px;
    }
    .add-category-block:hover { background: var(--bg-block); color: var(--text-main); }

    /* Dialog & Buttons */
    dialog {
        border: none; border-radius: 24px; padding: 0;
        background: var(--bg-surface); color: var(--text-main);
        width: 90%; max-width: 440px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
    }
    dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
    
    .modal-header { padding: 24px 30px; font-weight: 800; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 0 30px 30px; display: flex; flex-direction: column; gap: 20px; }
    .form-group label { display: block; font-size: 13px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; }
    .form-input {
        width: 100%; padding: 12px 16px; border-radius: 12px; border: none;
        background: var(--bg-block); color: var(--text-main); font-size: 15px; font-weight: 500; transition: background 0.2s;
    }
    .form-input:focus { background: var(--bg-active); }
    .modal-footer { padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-app); }

    .btn { padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-size: 14px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
    .btn-primary { background: var(--accent); color: var(--accent-fg); width: 100%; }
    .btn-primary:hover { opacity: 0.8; }
    .btn-secondary { background: var(--bg-block); color: var(--text-main); width: 100%; }
    .btn-secondary:hover { background: var(--bg-active); }
    .btn-danger { color: var(--danger); background: transparent; padding: 10px 20px; }
    .btn-danger:hover { background: var(--danger-bg); border-radius: 12px; }
    .home-link { display: block; text-align: center; color: var(--text-sub); font-size: 13px; text-decoration: none; margin-top: 15px; font-weight: 600; }
    .home-link:hover { color: var(--text-main); }

    /* === Mobile Adaption === */
    @media (max-width: 768px) {
        .mobile-header { display: flex; }
        
        aside { 
            transform: translateX(-100%); /* 默认隐藏侧边栏 */
            width: 100%; 
            border-right: none;
            background: var(--bg-surface);
            top: var(--header-height); /* 避开顶栏 */
        }
        aside.mobile-active { transform: translateX(0); }

        main { 
            margin-left: 0; 
            padding: 20px 16px 80px 16px; 
            margin-top: var(--header-height); /* 避开顶栏 */
            width: 100%;
        }

        .dashboard-header { 
            flex-direction: column; 
            align-items: flex-start;
            padding: 20px;
            gap: 16px;
        }
        .stats-row { width: 100%; }
        .stat-pill { flex: 1; }

        .app-grid { grid-template-columns: 1fr; gap: 10px; }
        .app-card { padding: 16px; border-radius: 14px; }
        .card-controls { opacity: 1; position: relative; top: 0; right: 0; margin-left: auto; }
        .icon-wrapper { width: 42px; height: 42px; margin-right: 12px; }
    }
</style>
</head>
<body>

<div class="mobile-header">
    <div class="menu-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
    <div class="mobile-title">后台管理</div>
    <div style="width:20px;"></div> </div>

<aside id="sidebar">
    <div class="brand" onclick="location.reload()">
        <img src="https://wangwenzhi.eu.org/images/ulefone-logo/icon.png" alt="Logo">
        <span>Admin Panel</span>
    </div>
    
    <div class="nav-list" id="navList"></div>
    
    <div class="sidebar-footer">
        <button class="btn btn-primary" id="downloadBtn">
            <i class="fa-solid fa-download"></i> 下载配置
        </button>
        <button class="btn btn-secondary" onclick="window.open('https://github.com/wangwenzhiwwz/Ulefone-Navigation/upload/main', '_blank')">
            <i class="fa-brands fa-github"></i> 数据仓库
        </button>
        <a href="index.html" class="home-link">返回前台首页 &rarr;</a>
    </div>
</aside>

<main id="mainContent">
    <div class="dashboard-header">
        <div class="dash-info">
            <h1>Ulefone Admin</h1>
            <p>拖拽排序，点击编辑，实时管理。</p>
        </div>
        <div class="stats-row">
            <div class="stat-pill">
                <div class="stat-val" id="totalApps">0</div>
                <div class="stat-lbl">书签</div>
            </div>
            <div class="stat-pill">
                <div class="stat-val" id="totalCats">0</div>
                <div class="stat-lbl">分类</div>
            </div>
        </div>
    </div>

    <div id="contentArea"></div>
    
    <div class="add-category-block" onclick="addCategory()">
        <i class="fa-solid fa-plus"></i> 新建分类分组
    </div>
</main>

<dialog id="editModal">
    <div class="modal-header">
        <span id="modalTitle">编辑应用</span>
        <button class="control-btn" onclick="closeModal()"><i class="fa-solid fa-times"></i></button>
    </div>
    <div class="modal-body">
        <div style="display: flex; gap: 20px; align-items: center;">
            <div style="width: 64px; height: 64px; border-radius: 16px; background: var(--bg-block); overflow: hidden; display: flex; align-items: center; justify-content: center;">
                <img id="modalIconPreview" src="" style="width: 65%; height: 65%; object-fit: contain;">
            </div>
            <div style="flex:1;">
                <label style="font-size:13px; color:var(--text-sub); margin-bottom:5px;">图标预览</label>
                <div style="font-size:14px; color:var(--text-main); font-weight:500;">自动获取或使用链接</div>
            </div>
        </div>
        
        <div class="form-group"><label>应用名称</label><input class="form-input" id="inpName" placeholder="例如: Google"></div>
        <div class="form-group"><label>跳转链接</label><input class="form-input" id="inpLink" placeholder="https://..."></div>
        <div class="form-group"><label>自定义图标 URL (可选)</label><input class="form-input" id="inpIcon" oninput="updateModalPreview(document.getElementById('inpLink').value, this.value)" placeholder="为空则自动获取 Favicon"></div>
    </div>
    <div class="modal-footer">
        <button class="btn-danger" onclick="confirmDelete()">删除</button>
        <button class="btn btn-primary" style="width: auto; padding: 14px 40px;" onclick="saveEdit()">保存</button>
    </div>
</dialog>

<script src="data.js"></script>
<script>
const appsJsTemplate = `const data = %APPDATA_REPLACE%;`;
let currentEdit = { ci: '', ai: -1 };

// 检测并加载深色模式
if (localStorage.getItem('darkMode') === 'enabled' || (window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('darkMode'))) {
    document.body.classList.add('dark-mode');
}

function render() {
    const nav = document.getElementById('navList');
    const area = document.getElementById('contentArea');
    
    const catKeys = Object.keys(data);
    const totalApps = Object.values(data).flat().length;
    document.getElementById('totalApps').textContent = totalApps;
    document.getElementById('totalCats').textContent = catKeys.length;

    nav.innerHTML = '';
    area.innerHTML = '';

    catKeys.forEach((key, index) => {
        const navItem = document.createElement('div');
        navItem.className = 'nav-item';
        navItem.innerHTML = `<span>${key}</span> <span class="badge">${data[key].length}</span>`;
        navItem.onclick = () => {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            navItem.classList.add('active');
            document.getElementById(`group-${index}`).scrollIntoView({behavior: 'smooth', block: 'start'});
            if(window.innerWidth <= 768) toggleSidebar(); // 手机点击后收起侧栏
        };
        nav.appendChild(navItem);

        const section = document.createElement('div');
        section.className = 'cat-section';
        section.id = `group-${index}`;
        
        const header = document.createElement('div');
        header.className = 'cat-header';
        header.innerHTML = `
            <input class="cat-title-input" value="${key}" onchange="renameCategory('${key}', this.value)">
            <button class="control-btn btn-del" onclick="deleteCategory('${key}')" title="删除整组"><i class="fa-solid fa-trash"></i></button>
        `;
        section.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'app-grid';
        
        data[key].forEach((app, ai) => {
            const domain = getDomain(app.url);
            const favicon = app.icon || `https://www.google.com/s2/favicons?sz=64&domain_url=${app.url}`;
            
            const card = document.createElement('div');
            card.className = 'app-card';
            card.draggable = true;
            card.dataset.cat = key;
            card.dataset.idx = ai;
            
            // 点击跳转
            card.onclick = (e) => {
                if(!e.target.closest('.control-btn')) {
                    window.open(app.url, '_blank');
                }
            };

            // 编辑按钮
            card.innerHTML = `
                <div class="icon-wrapper">
                    <img class="app-icon-img" src="${favicon}" onerror="this.src='https://ui-avatars.com/api/?name=${app.name}&background=random&color=fff&size=64';">
                </div>
                <div class="card-meta">
                    <div class="app-name">${app.name}</div>
                    <div class="app-desc">${domain}</div>
                </div>
                <div class="card-controls">
                    <button class="control-btn" onclick="event.stopPropagation(); openEdit('${key}', ${ai})" title="编辑"><i class="fa-solid fa-pen"></i></button>
                    <button class="control-btn btn-del" onclick="event.stopPropagation(); deleteApp('${key}', ${ai})" title="删除"><i class="fa-solid fa-minus"></i></button>
                </div>
            `;
            grid.appendChild(card);
        });

        const addBtn = document.createElement('div');
        addBtn.className = 'add-card';
        addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> 添加书签';
        addBtn.onclick = () => addApp(key);
        grid.appendChild(addBtn);

        section.appendChild(grid);
        area.appendChild(section);
    });

    setupDrag();
    setupScrollSpy();
}

function getDomain(url) {
    try { return new URL(url).hostname.replace('www.', ''); } catch { return 'link'; }
}

function setupScrollSpy() {
    const main = document.getElementById('mainContent');
    const sections = document.querySelectorAll('.cat-section');
    const navItems = document.querySelectorAll('.nav-item');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                navItems.forEach(item => item.classList.remove('active'));
                const index = Array.from(sections).indexOf(entry.target);
                if (navItems[index]) navItems[index].classList.add('active');
            }
        });
    }, { root: null, threshold: 0.1 }); // Modified root for better mobile support

    sections.forEach(section => observer.observe(section));
}

const modal = document.getElementById('editModal');
function openEdit(key, ai) {
    currentEdit = { ci: key, ai: ai };
    const app = data[key][ai];
    document.getElementById('inpName').value = app.name;
    document.getElementById('inpLink').value = app.url;
    document.getElementById('inpIcon').value = app.icon || '';
    updateModalPreview(app.url, app.icon);
    modal.showModal();
}

function updateModalPreview(url, customIcon) {
    const img = document.getElementById('modalIconPreview');
    if(customIcon) {
        img.src = customIcon;
    } else {
        const domain = getDomain(url);
        img.src = `https://www.google.com/s2/favicons?sz=64&domain_url=${url}`;
    }
    img.onerror = () => img.src = `https://ui-avatars.com/api/?name=App&background=f0f0f0&color=333&size=64`;
}

function saveEdit() {
    const { ci, ai } = currentEdit;
    if(!ci) return;
    
    const newName = document.getElementById('inpName').value;
    const newLink = document.getElementById('inpLink').value;
    const newIcon = document.getElementById('inpIcon').value;
    
    data[ci][ai] = {
        name: newName,
        url: newLink,
        ...(newIcon && { icon: newIcon })
    };
    
    closeModal();
    render();
}

function closeModal() { modal.close(); }

// 删除当前编辑项
function confirmDelete() {
    const { ci, ai } = currentEdit;
    if(ci && confirm('确定删除?')) {
        data[ci].splice(ai, 1);
        closeModal();
        render();
    }
}

window.addApp = (key) => {
    data[key].push({ name: "新书签", url: "https://example.com" });
    render();
    openEdit(key, data[key].length - 1);
};

window.deleteApp = (key, idx) => {
    if(confirm('确定删除?')) {
        data[key].splice(idx, 1);
        render();
    }
};

window.addCategory = () => {
    const name = prompt("请输入新分类名称:", "新分类");
    if(name && !data[name]) {
        data[name] = [];
        render();
        setTimeout(() => {
            const main = document.getElementById('mainContent');
            main.scrollTop = main.scrollHeight;
        }, 100);
    } else if (data[name]) {
        alert("分类已存在");
    }
};

window.renameCategory = (oldName, newName) => {
    if(oldName === newName) return;
    if(data[newName]) {
        alert("分类名已存在");
        render();
        return;
    }
    const newData = {};
    Object.keys(data).forEach(key => {
        if(key === oldName) {
            newData[newName] = data[oldName];
        } else {
            newData[key] = data[key];
        }
    });
    Object.keys(data).forEach(k => delete data[k]);
    Object.assign(data, newData);
    render();
};

window.deleteCategory = (key) => {
    if(confirm(`确定删除分类 "${key}" 及其所有书签吗?`)) {
        delete data[key];
        render();
    }
};

function setupDrag() {
    let dragged = null;
    document.querySelectorAll('.app-card').forEach(card => {
        card.addEventListener('dragstart', function() { 
            dragged = this; 
            this.style.opacity = '0.5';
        });
        card.addEventListener('dragend', function() { 
            this.style.opacity = '1'; 
            dragged = null; 
        });
        card.addEventListener('dragover', e => e.preventDefault());
        card.addEventListener('drop', function(e) {
            e.preventDefault();
            if(!dragged || dragged === this) return;
            
            const sCat = dragged.dataset.cat;
            const sIdx = parseInt(dragged.dataset.idx);
            const tCat = this.dataset.cat;
            const tIdx = parseInt(this.dataset.idx);
            
            const item = data[sCat].splice(sIdx, 1)[0];
            data[tCat].splice(tIdx, 0, item);
            
            render();
        });
    });
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('mobile-active');
}

// 点击内容区域关闭侧边栏
document.getElementById('mainContent').addEventListener('click', () => {
    const sidebar = document.getElementById('sidebar');
    if(window.innerWidth <= 768 && sidebar.classList.contains('mobile-active')) {
        sidebar.classList.remove('mobile-active');
    }
});

document.getElementById('downloadBtn').onclick = () => {
    const content = appsJsTemplate.replace('%APPDATA_REPLACE%', JSON.stringify(data, null, 4));
    const blob = new Blob([content], {type: "application/javascript"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "data.js";
    a.click();
};

render();
</script>
</body>
</html>