<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理后台 - App WWZ</title>
<link rel="icon" href="https://wangwenzhi.eu.org/images/ulefone-logo/icon.png" sizes="32x32" type="image/png"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        /* 色块系统 */
        --bg-app: #f5f5f7;        
        --bg-surface: #ffffff;    
        --bg-block: #efeff1;      
        --bg-active: #e5e5e7;     
        
        --text-main: #000000;
        --text-sub: #86868b;
        
        --accent: #000000;
        --accent-fg: #ffffff;
        
        --danger: #ff3b30;
        --danger-bg: #fff2f2;
        
        /* 尺寸系统 */
        --radius-l: 24px;
        --radius-m: 16px;
        --radius-s: 12px;
        --pill: 99px;
        
        --sidebar-w: 240px;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --bg-app: #000000;
            --bg-surface: #1c1c1e;
            --bg-block: #2c2c2e;
            --bg-block-hover: #3a3a3c;
            --text-main: #ffffff;
            --text-sub: #98989d;
            --accent: #ffffff;
            --accent-fg: #000000;
            --danger-bg: #3a0b0b;
        }
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        background: var(--bg-app);
        color: var(--text-main);
        height: 100vh;
        overflow: hidden;
        margin: 0;
        display: flex;
        font-size: 16px;
    }

    /* === Sidebar === */
    aside {
        width: var(--sidebar-w);
        background: var(--bg-surface);
        display: flex; flex-direction: column;
        padding: 30px 16px;
        z-index: 10;
    }

    .brand {
        display: flex; align-items: center; gap: 14px;
        font-size: 20px; font-weight: 800; color: var(--text-main);
        margin-bottom: 40px; padding-left: 8px;
    }
    .brand img { width: 36px; height: 36px; border-radius: 8px; }

    .nav-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
    .nav-list::-webkit-scrollbar { display: none; }

    .nav-item {
        padding: 12px 20px; 
        border-radius: var(--pill); 
        cursor: pointer;
        display: flex; justify-content: space-between; align-items: center;
        color: var(--text-sub); 
        font-size: 15px; font-weight: 600;
        background: transparent;
        transition: all 0.2s;
    }
    .nav-item:hover { background: var(--bg-block); color: var(--text-main); }
    
    .nav-item.active { 
        background: var(--bg-active); 
        color: var(--text-main); 
        font-weight: 700;
    }
    .nav-item.active .badge { background: #dcdce0; color: var(--text-main); }
    
    .badge { 
        font-size: 12px; background: var(--bg-block); 
        padding: 2px 8px; border-radius: 99px; color: var(--text-sub); 
        transition: all 0.2s; font-weight: 600;
    }

    .sidebar-footer { margin-top: 30px; display: flex; flex-direction: column; gap: 12px; }

    /* === Main Content === */
    main {
        flex: 1; height: 100%; overflow-y: auto;
        padding: 30px 40px 80px 40px; 
        background: var(--bg-app); 
    }

    .dashboard-header {
        background: var(--bg-surface);
        border-radius: var(--radius-l);
        padding: 40px;
        margin-bottom: 40px;
    }
    .dash-title { font-size: 28px; font-weight: 800; margin-bottom: 10px; color: var(--text-main); letter-spacing: -0.5px; }
    .dash-desc { color: var(--text-sub); font-size: 15px; margin-bottom: 30px; font-weight: 500; }
    
    .stats-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .stat-pill {
        background: var(--bg-block);
        padding: 20px 30px; border-radius: var(--radius-m);
        display: flex; flex-direction: column; gap: 4px;
        min-width: 140px;
    }
    .stat-val { font-size: 24px; font-weight: 800; line-height: 1; color: var(--text-main); }
    .stat-lbl { font-size: 13px; color: var(--text-sub); font-weight: 600; }

    /* Sections */
    .cat-section { margin-bottom: 50px; scroll-margin-top: 40px; }
    .cat-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
    
    .cat-title-input {
        font-size: 22px; font-weight: 800; 
        background: transparent; border: none;
        color: var(--text-main); flex: 1; padding: 8px 0;
        border-radius: 8px; transition: all 0.2s;
    }
    .cat-title-input:hover, .cat-title-input:focus { padding-left: 12px; background: var(--bg-block); }

    /* === Cards === */
    .app-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 12px;
    }

    .app-card {
        background: var(--bg-surface);
        border-radius: var(--radius-m);
        padding: 16px;
        display: flex; flex-direction: row; align-items: center;
        position: relative;
        cursor: grab;
        transition: transform 0.2s, background 0.2s;
        min-height: 80px;
    }
    .app-card:hover { transform: translateY(-2px); z-index: 2; outline: 2px solid rgba(0,0,0,0.03); }
    .app-card:active { cursor: grabbing; transform: scale(0.98); }
    .app-card.dragging { opacity: 0.4; }
    
    .icon-wrapper {
        width: 44px; height: 44px; 
        margin-right: 16px; 
        border-radius: 10px;
        background: var(--bg-block); 
        overflow: hidden; flex-shrink: 0;
        display: flex; align-items: center; justify-content: center;
    }
    .app-icon-img { width: 65%; height: 65%; object-fit: contain; }
    
    .card-meta { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
    .app-name { 
        font-size: 16px; font-weight: 700; margin-bottom: 2px; color: var(--text-main);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .app-desc { 
        font-size: 13px; color: var(--text-sub);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* Controls (核心修改：添加编辑按钮) */
    .card-controls {
        position: absolute; top: 12px; right: 12px;
        display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s;
    }
    .app-card:hover .card-controls { opacity: 1; }

    .control-btn {
        width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        background: var(--bg-block); color: var(--text-main);
        font-size: 13px; transition: background 0.2s;
    }
    .control-btn:hover { background: var(--bg-active); }
    .control-btn.btn-del { background: var(--danger-bg); color: var(--danger); }
    .control-btn.btn-del:hover { background: var(--danger); color: #fff; }

    /* Add Button */
    .add-card {
        background: transparent; 
        border: 2px dashed var(--bg-block);
        border-radius: var(--radius-m);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: var(--text-sub); cursor: pointer; min-height: 80px;
        font-size: 14px; gap: 8px; font-weight: 600;
        transition: all 0.2s;
    }
    .add-card:hover { border-color: var(--text-main); color: var(--text-main); background: var(--bg-block); }

    .add-category-block {
        background: var(--bg-surface); border-radius: var(--radius-l); padding: 24px;
        text-align: center; color: var(--text-sub); cursor: pointer;
        margin-top: 20px; font-weight: 600; transition: all 0.2s; font-size: 16px;
    }
    .add-category-block:hover { background: var(--bg-block); color: var(--text-main); }

    /* Dialog */
    dialog {
        border: none; border-radius: var(--radius-l); padding: 0;
        background: var(--bg-surface); color: var(--text-main);
        width: 90%; max-width: 460px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
    }
    dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
    
    .modal-header { padding: 24px 30px; font-weight: 800; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 0 30px 30px; display: flex; flex-direction: column; gap: 20px; }
    
    .form-group label { display: block; font-size: 14px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; }
    .form-input {
        width: 100%; padding: 14px 20px; 
        border-radius: var(--radius-s); border: none;
        background: var(--bg-block); color: var(--text-main); font-size: 15px; font-weight: 500;
        transition: background 0.2s;
    }
    .form-input:focus { background: var(--bg-active); }
    .modal-footer { padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-app); }

    /* Buttons */
    .btn { 
        padding: 14px; border-radius: var(--radius-s); border: none; cursor: pointer; 
        font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; 
        transition: all 0.2s;
    }
    .btn-primary { background: var(--accent); color: var(--accent-fg); width: 100%; }
    .btn-primary:hover { opacity: 0.8; }
    .btn-secondary { background: var(--bg-block); color: var(--text-main); width: 100%; }
    .btn-secondary:hover { background: var(--bg-active); }
    .btn-danger { color: var(--danger); background: transparent; padding: 10px 20px; }
    .btn-danger:hover { background: var(--danger-bg); border-radius: var(--radius-s); }

    .home-link {
        display: block; text-align: center; color: var(--text-sub); font-size: 14px; 
        text-decoration: none; margin-top: 15px; font-weight: 600;
    }
    .home-link:hover { color: var(--text-main); }

    @media (max-width: 768px) {
        body { flex-direction: column; height: auto; min-height: 100vh; }
        aside { width: 100%; padding: 20px; border-bottom: 1px solid var(--bg-block); }
        .nav-list { display: none; } 
        .brand { margin-bottom: 15px; }
        .sidebar-footer { flex-direction: row; flex-wrap: wrap; margin-top: 0; }
        .sidebar-footer .btn { flex: 1; }
        main { padding: 20px; }
        .dashboard-header { padding: 24px; border-radius: var(--radius-m); }
        .stats-row { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 10px; }
        .stat-pill { min-width: 120px; padding: 16px; }
        .app-grid { grid-template-columns: 1fr; gap: 10px; }
        .card-controls { opacity: 1; position: relative; top: 0; right: 0; margin-left: auto; }
        .app-card { padding: 16px; }
    }
</style>
</head>
<body>

<aside>
    <div class="brand">
        <img src="https://wangwenzhi.eu.org/images/ulefone-logo/icon.png" alt="Logo">
        <span>管理后台</span>
    </div>
    
    <div class="nav-list" id="navList"></div>
    
    <div class="sidebar-footer">
        <button class="btn btn-primary" id="downloadBtn">
            <i class="fa-solid fa-download"></i> 下载配置
        </button>
        <button class="btn btn-secondary" onclick="window.open('https://github.com/wangwenzhiwwz/Ulefone-Navigation/upload/main', '_blank')">
            <i class="fa-brands fa-github"></i> 数据仓库
        </button>
        <a href="index.html" class="home-link">返回前台首页 &rarr;</a>
    </div>
</aside>

<main id="mainContent">
    <div class="dashboard-header">
        <div class="dash-title">Ulefone Admin</div>
        <div class="dash-desc">极简后台管理，拖拽排序，点击编辑。</div>
        <div class="stats-row">
            <div class="stat-pill">
                <div class="stat-val" id="totalApps">0</div>
                <div class="stat-lbl">书签总数</div>
            </div>
            <div class="stat-pill">
                <div class="stat-val" id="totalCats">0</div>
                <div class="stat-lbl">分类数量</div>
            </div>
        </div>
    </div>

    <div id="contentArea"></div>
    
    <div class="add-category-block" onclick="addCategory()">
        <i class="fa-solid fa-plus"></i> 新建分类分组
    </div>
</main>

<dialog id="editModal">
    <div class="modal-header">
        <span id="modalTitle">编辑应用</span>
        <button class="control-btn" onclick="closeModal()"><i class="fa-solid fa-times"></i></button>
    </div>
    <div class="modal-body">
        <div style="display: flex; gap: 20px; align-items: center;">
            <div style="width: 64px; height: 64px; border-radius: 16px; background: var(--bg-block); overflow: hidden; display: flex; align-items: center; justify-content: center;">
                <img id="modalIconPreview" src="" style="width: 65%; height: 65%; object-fit: contain;">
            </div>
            <div style="flex:1;">
                <label style="font-size:13px; color:var(--text-sub); margin-bottom:5px;">图标预览</label>
                <div style="font-size:14px; color:var(--text-main); font-weight:500;">自动获取或使用链接</div>
            </div>
        </div>
        
        <div class="form-group"><label>应用名称</label><input class="form-input" id="inpName" placeholder="例如: Google"></div>
        <div class="form-group"><label>跳转链接</label><input class="form-input" id="inpLink" placeholder="https://..."></div>
        <div class="form-group"><label>自定义图标 URL (可选)</label><input class="form-input" id="inpIcon" oninput="updateModalPreview(document.getElementById('inpLink').value, this.value)" placeholder="为空则自动获取 Favicon"></div>
    </div>
    <div class="modal-footer">
        <button class="btn-danger" onclick="confirmDelete()">删除</button>
        <button class="btn btn-primary" style="width: auto; padding: 14px 40px;" onclick="saveEdit()">保存</button>
    </div>
</dialog>

<script src="data.js"></script>
<script>
const appsJsTemplate = `const data = %APPDATA_REPLACE%;`;
let currentEdit = { ci: '', ai: -1 };

function render() {
    const nav = document.getElementById('navList');
    const area = document.getElementById('contentArea');
    
    const catKeys = Object.keys(data);
    const totalApps = Object.values(data).flat().length;
    document.getElementById('totalApps').textContent = totalApps;
    document.getElementById('totalCats').textContent = catKeys.length;

    nav.innerHTML = '';
    area.innerHTML = '';

    catKeys.forEach((key, index) => {
        // Sidebar Item
        const navItem = document.createElement('div');
        navItem.className = 'nav-item';
        navItem.innerHTML = `<span>${key}</span> <span class="badge">${data[key].length}</span>`;
        navItem.onclick = () => {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            navItem.classList.add('active');
            document.getElementById(`group-${index}`).scrollIntoView({behavior: 'smooth', block: 'start'});
        };
        nav.appendChild(navItem);

        // Section
        const section = document.createElement('div');
        section.className = 'cat-section';
        section.id = `group-${index}`;
        
        // Header
        const header = document.createElement('div');
        header.className = 'cat-header';
        header.innerHTML = `
            <input class="cat-title-input" value="${key}" onchange="renameCategory('${key}', this.value)">
            <button class="control-btn btn-del" onclick="deleteCategory('${key}')" title="删除整组"><i class="fa-solid fa-trash"></i></button>
        `;
        section.appendChild(header);

        // Grid
        const grid = document.createElement('div');
        grid.className = 'app-grid';
        
        data[key].forEach((app, ai) => {
            const domain = getDomain(app.url);
            const favicon = app.icon || `https://www.google.com/s2/favicons?sz=64&domain_url=${app.url}`;
            
            const card = document.createElement('div');
            card.className = 'app-card';
            card.draggable = true;
            card.dataset.cat = key;
            card.dataset.idx = ai;
            
            // 核心逻辑：默认点击跳转，不触发编辑
            card.onclick = (e) => {
                if(!e.target.closest('.control-btn')) {
                    window.open(app.url, '_blank');
                }
            };

            // 核心修改：增加编辑按钮
            card.innerHTML = `
                <div class="icon-wrapper">
                    <img class="app-icon-img" src="${favicon}" onerror="this.src='https://ui-avatars.com/api/?name=${app.name}&background=random&color=fff&size=64';">
                </div>
                <div class="card-meta">
                    <div class="app-name">${app.name}</div>
                    <div class="app-desc">${domain}</div>
                </div>
                <div class="card-controls">
                    <button class="control-btn" onclick="event.stopPropagation(); openEdit('${key}', ${ai})" title="编辑"><i class="fa-solid fa-pen"></i></button>
                    <button class="control-btn btn-del" onclick="event.stopPropagation(); deleteApp('${key}', ${ai})" title="删除"><i class="fa-solid fa-minus"></i></button>
                </div>
            `;
            grid.appendChild(card);
        });

        // Add Btn
        const addBtn = document.createElement('div');
        addBtn.className = 'add-card';
        addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> 添加书签';
        addBtn.onclick = () => addApp(key);
        grid.appendChild(addBtn);

        section.appendChild(grid);
        area.appendChild(section);
    });

    setupDrag();
    setupScrollSpy();
}

function getDomain(url) {
    try { return new URL(url).hostname.replace('www.', ''); } catch { return 'link'; }
}

function setupScrollSpy() {
    const main = document.getElementById('mainContent');
    const sections = document.querySelectorAll('.cat-section');
    const navItems = document.querySelectorAll('.nav-item');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                navItems.forEach(item => item.classList.remove('active'));
                const index = Array.from(sections).indexOf(entry.target);
                if (navItems[index]) navItems[index].classList.add('active');
            }
        });
    }, { root: main, threshold: 0.1, rootMargin: "-10% 0px -70% 0px" });

    sections.forEach(section => observer.observe(section));
}

const modal = document.getElementById('editModal');
function openEdit(key, ai) {
    currentEdit = { ci: key, ai: ai };
    const app = data[key][ai];
    document.getElementById('inpName').value = app.name;
    document.getElementById('inpLink').value = app.url;
    document.getElementById('inpIcon').value = app.icon || '';
    updateModalPreview(app.url, app.icon);
    modal.showModal();
}

function updateModalPreview(url, customIcon) {
    const img = document.getElementById('modalIconPreview');
    if(customIcon) {
        img.src = customIcon;
    } else {
        const domain = getDomain(url);
        img.src = `https://www.google.com/s2/favicons?sz=64&domain_url=${url}`;
    }
    img.onerror = () => img.src = `https://ui-avatars.com/api/?name=App&background=f0f0f0&color=333&size=64`;
}

function saveEdit() {
    const { ci, ai } = currentEdit;
    if(!ci) return;
    
    const newName = document.getElementById('inpName').value;
    const newLink = document.getElementById('inpLink').value;
    const newIcon = document.getElementById('inpIcon').value;
    
    data[ci][ai] = {
        name: newName,
        url: newLink,
        ...(newIcon && { icon: newIcon })
    };
    
    closeModal();
    render();
}

function closeModal() { modal.close(); }

window.addApp = (key) => {
    data[key].push({ name: "新书签", url: "https://example.com" });
    render();
    openEdit(key, data[key].length - 1);
};

window.deleteApp = (key, idx) => {
    if(confirm('确定删除?')) {
        data[key].splice(idx, 1);
        render();
    }
};

window.addCategory = () => {
    const name = prompt("请输入新分类名称:", "新分类");
    if(name && !data[name]) {
        data[name] = [];
        render();
        setTimeout(() => {
            const main = document.getElementById('mainContent');
            main.scrollTop = main.scrollHeight;
        }, 100);
    } else if (data[name]) {
        alert("分类已存在");
    }
};

window.renameCategory = (oldName, newName) => {
    if(oldName === newName) return;
    if(data[newName]) {
        alert("分类名已存在");
        render();
        return;
    }
    const newData = {};
    Object.keys(data).forEach(key => {
        if(key === oldName) {
            newData[newName] = data[oldName];
        } else {
            newData[key] = data[key];
        }
    });
    Object.keys(data).forEach(k => delete data[k]);
    Object.assign(data, newData);
    render();
};

window.deleteCategory = (key) => {
    if(confirm(`确定删除分类 "${key}" 及其所有书签吗?`)) {
        delete data[key];
        render();
    }
};

function setupDrag() {
    let dragged = null;
    document.querySelectorAll('.app-card').forEach(card => {
        card.addEventListener('dragstart', function() { 
            dragged = this; 
            this.style.opacity = '0.5';
        });
        card.addEventListener('dragend', function() { 
            this.style.opacity = '1'; 
            dragged = null; 
        });
        card.addEventListener('dragover', e => e.preventDefault());
        card.addEventListener('drop', function(e) {
            e.preventDefault();
            if(!dragged || dragged === this) return;
            
            const sCat = dragged.dataset.cat;
            const sIdx = parseInt(dragged.dataset.idx);
            const tCat = this.dataset.cat;
            const tIdx = parseInt(this.dataset.idx);
            
            const item = data[sCat].splice(sIdx, 1)[0];
            data[tCat].splice(tIdx, 0, item);
            
            render();
        });
    });
}

document.getElementById('downloadBtn').onclick = () => {
    const content = appsJsTemplate.replace('%APPDATA_REPLACE%', JSON.stringify(data, null, 4));
    const blob = new Blob([content], {type: "application/javascript"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "data.js";
    a.click();
};

render();
</script>
</body>
</html>